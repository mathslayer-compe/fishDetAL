# Samplers (samplers)

This directory provides **modular components** for implementing **Active Learning (AL)** strategies in machine learning 
workflows.  

Each sampler defines a strategy for selecting the most **informative unlabeled samples**, helping improve model performance 
efficiently.  

Currently, the toolkit includes an **[Uncertainty Sampler](https://github.com/mathslayer-compe/fishDetAL/blob/main/src/samplers/uncertainty_sampling.py)**, which aggregates confidence/entropy scores from a YOLO model's 
predictions on images, and a **[Random Sampler]([https://github.com/UCSD-E4E/AL_toolkit/blob/main/src/al_toolkit/random_sampling.py](https://github.com/mathslayer-compe/fishDetAL/blob/main/src/samplers/random_sampling.py)** that randomly selects images after training. This is used more for the purpose of establishing a baseline metric in research. 

## Uncertainty Sampling
The 2 methods of uncertainty sampling that are supported by the sampler are:

1) Least Confidence Sampling – selects examples where the model is least confident in its prediction, typically based on the highest uncertainty (lowest confidence) derived from the model’s confidence score on a bounding box

2) Entropy-based Sampling – selects examples where the model is most uncertain (highest entropy), measured using the entropy of the probability distribution over possible outcomes (object vs. non-object for single-class detection)

### Confidence Scoring
During inference, the confidence of a predicted bounding box is defined as:

**box confidence** = P(class∣object) * P(object)

In this project, which involves a single-class detection problem, we have:

**P(class∣object)=1**

so the formula simplifies to:

**box confidence** = P(object)

That is, the confidence score is identical to the objectness score.

When performing Least Confidence Sampling, uncertainty can be measured as 1−P(object). Bounding boxes with the lowest confidence (objectness) are therefore the most uncertain and are selected by the uncertainty sampler after a training iteration.

Entropy can also be computed directly from the box confidence. Treating the event “object detected in this bounding box” as a binary random variable with probability $c_i$ = P(object), the binary entropy for a single bounding box is:

$$s_i = -[c_ilog(c_i) + (1-c_i)log(1-c_i)]$$


This formulation allows the confidence score array outputted by the YOLO model to be converted into an entropy score array, which can then be used for Entropy-based Sampling in active learning.

### Least Confidence Sampling
All the sampling is done on the confidence score arrays generated by the model during a prediction. From this, an overall confidence score is assigned to an image. There are 2 possible ways of assigining a confidence score to an image.

1) **Mean Confidence Score Pooling**
    
    Given the quantities:
    
    1) N = number of objectes detected in an image by model
    2) $c_i$ = confidence score of each detected object
    3) $C_{img}$ = confidence score of an image

    $$\large C_{img} = \frac{1}{N}\sum_{i=1}^Nc_i$$

    Enable this by setting method as 'avg' and entropy as 'False' in the training YAML config file.

2) **Minimum Confidence Score Pooling**

    Given the quantities:
    1) N = number of objectes detected in an image by model
    2) $c_i$ = confidence score of each detected object
    3) $C_{img}$ = confidence score of an image

       $$\large C_{\text{img}} = \min_{1 \le i \le N} c_i$$
    
    Enable this by setting method as 'min' and entropy as 'False' in the training YAML config file.

### Entropy-based Sampling
The confidence scores from the prediction arrays are converted to entropy scores using the entropy formula above. Once the arrays are created, the an overall entropy score is assigned to an image. There are 2 possible ways of assigning an entropy score to an image.

1) **Mean Entropy Score Aggregation**

    Given the quantities:
    1) N = number of objectes detected in an image by model
    2) $s_i$ = entropy score of each detected object
    3) $S_{img}$ = entropy score of an image

        $$\large S_{img} = \frac{1}{N}\sum_{i=1}^Ns_i$$
    
    Enable this by setting method as 'avg' and entropy as 'True' in the training YAML config file.

2) **Maximum Entropy Score Aggregation**
    Given the quantities:
    1) N = number of objectes detected in an image by model
    2) $s_i$ = entropy score of each detected object
    3) $S_{img}$ = entropy score of an image

        $$\large S_{\text{img}} = \max_{1 \le i \le N} s_i$$
    
    Enable this by setting method as 'max' and entropy as 'True' in the training YAML config file.


## Results
Training was done across 5 random seeds of initially labeled data comparing the 5 sampling methods. The entries in the table below show the mAP50-95 of a YOLOv8n model after 4 iterations of training that were 50 epochs each and had 5% of total training data labeled before each training iteration.


| Method                              | Seed 1 mAP50-95 | Seed 2 mAP50-95 | Seed 3 mAP50-95 | Seed 4 mAP50-95 | Seed 5 mAP50-95 | Mean   | Standard Deviation |
|------------------------------------|-----------------|-----------------|-----------------|-----------------|-----------------|--------|--------------------|
| Random Sampling                    | 0.565           | 0.559           | 0.561           | 0.568           | 0.568           | 0.5642 | 0.00409    |
| Least Confidence (Mean Aggregation)    | 0.510           | 0.530           | 0.539           | 0.514           | 0.515           | 0.5216 | 0.0123     |
| Least Confidence (Min Aggregation)     | 0.575           | 0.568           | 0.586           | 0.573           | 0.591           | 0.5786 | 0.00956     |
| Entropy (Mean Aggregation)             | 0.566           | 0.563           | 0.549           | 0.566           | 0.571           | 0.5630 | 0.00834        |
| Entropy (Max Aggregation)              | 0.583           | 0.575           | 0.574           | 0.582           | 0.577           | 0.5782 | 0.00409    |


More information related to statistical significance can be found in the demo notebook [ttests.ipynb](https://github.com/mathslayer-compe/fishDetAL/blob/main/demos/ttests.ipynb).

